---
title: "Querying NYC Taxi Data in SQL"
subtitle: "SDS 192: MP5"
author: 
- name: Emily Rhyu
  affiliation: Smith College
- name: Kitty Chen 
  affiliation: Smith College
- name: Ale Munoz Garcia
  affiliation: Smith College
date: "`r format(Sys.Date(), '%B %e, %Y')`"
output: 
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    fig_width: 7
    fig_height: 6
    fig_caption: true
    code_folding: show
    df_print: paged
editor_options: 
  chunk_output_type: inline
references:
- id: xie2016bookdown
  type: book
  title: "Bookdown: Authoring books and technical documents with R markdown"
  author: 
  - family: Xie
    given: Yihui
  issued:
    year: 2016
  publisher: CRC Press
  url: https://bookdown.org/yihui/rmarkdown/
---

```{r setup, include=FALSE}
library(tidyverse)
library(sds192)
library(RMySQL)
db <- dbConnect(
  MySQL(), 
  host = "scidb.smith.edu", 
  user = "sds192", 
  password = "DSismfc@S", 
  dbname = "nyctaxi"
)

```

## Introduction

![](taxisinnewyork960.jpg)

## Exploratory data analysis

```{sql, connection = db}
SHOW DATABASES
```

```{sql, connection=db}
SHOW TABLES;
```

```{sql, connection=db}
DESCRIBE yellow;
```

## SQL Query
```{sql connection = db, output.var = "paytype"}
SELECT payment_type
FROM yellow
LIMIT 100;
```


## By Payment Type
```{sql connection = db, output.var = "payment"}
/*EXPLAIN*/
SELECT  tpep_dropoff_datetime, PULocationID, passenger_count, trip_distance, payment_type, total_amount, tip_amount, (tip_amount/total_amount)*100 AS tip_percent
FROM yellow
WHERE passenger_count < 4
  AND total_amount < 99 
  AND tip_amount > 0
/*ORDER BY trip_distance desc*/
ORDER BY RAND()
LIMIT 2800000;

```

```{r}
payment
```

## Data Wrangling

```{r, warning=FALSE, message=FALSE}
taxi_zones2 <- read_csv("taxi+_zone_lookup.csv")

payments_join <- payment %>%
  inner_join(taxi_zones2, by=c("PULocationID" = "LocationID"))

tip_by_borough <- payments_join %>%
  group_by(Borough)%>%
  summarize(
    N = n(),
    average = mean(tip_percent)
  )
```

## Geospatial Data

```{r}
url <- "https://data.cityofnewyork.us/api/geospatial/tqmj-j8zm?method=export&format=Shapefile"
local_file <- basename(url)
download.file(url, destfile = local_file)
unzip(local_file, exdir = "taxi_zone_bounds2")

library(sf)
dsn2 <- path.expand("taxi_zone_bounds2")
dsn2
list.files(dsn2)
```

```{r}
taxi_zone_look <- read_sf(dsn2)

taxi_w_tip <- taxi_zone_look %>%
  left_join(tip_by_borough, by=c("boro_name"="Borough"))

taxi_w_tip
```


```{r,warning=FALSE}
#shows boroughs of nyc
tz <- ggplot(data = taxi_w_tip, aes(color = boro_name)) +
  geom_sf(alpha = 0.5) +
  theme_void()+
   aes(fill = average)  +
   scale_fill_distiller(
     "Average % Tip",
     palette = "Spectral",
     limits = c(min(taxi_w_tip$average), max(taxi_w_tip$average)),
     na.value="black"
  )+
  geom_sf_label(aes(label = boro_name), fill = "white")  

tz
```

## Analysis

What did you discover? 

## Conclusion

What did you *learn* about the data set you explored?  

---

## Word count

```{r word_count, message=FALSE, echo=FALSE}
sds192::text_stats()
```

## Standards

In this assignment, we attempted the following [standards](https://beanumber.github.io/sds192/standards.html):

- `r standard_button("query")`: We met the Query standard because we...
- `r standard_button("github")`: We mastered the Github standard because we used Github to effectively collaborate and were able to resolve our merge conflicts.
- `r standard_button("markdown")`: We mastered the R Markdown standard because we used markdown to structure our information, made sure only necessary content was displayed on the page, and employed a variety of web elements.
- `r standard_button("wrangling")`: We mastered the Wrangling standard because we...
- `r standard_button("relational")`: We mastered the Relational standard because we...
- `r standard_button("aesthetics")`: We mastered the Aesthetics standard because we...
- `r standard_button("context")`: We mastered the Context standard because we...
- `r standard_button("ethics")`: We mastered the Ethics standard because we...
 - `r standard_button("spatial")`: We met the Spatial standard because we... 


Please see the [SQL chapter of the `bookdown` book](
https://rmarkdown.rstudio.com/authoring_knitr_engines.html%23sql#sql) for more information. 

You can cite references using parentheses or not. @xie2016bookdown wrote about this. See also [@xie2016bookdown].

## References
https://s3.amazonaws.com/nyc-tlc/misc/taxi+_zone_lookup.csv
https://data.cityofnewyork.us/api/geospatial/tqmj-j8zm?method=export&format=Shapefile
https://www.peoplesworld.org/article/the-decline-and-fall-of-the-nyc-taxi-industry/