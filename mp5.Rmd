---
title: "Querying Film Data in SQL"
subtitle: "SDS 192: MP5"
author: 
- name: Emily Rhyu
  affiliation: Smith College
- name: Kitty Chen 
  affiliation: Smith College
- name: Ale Munoz Garcia
  affiliation: Smith College
date: "`r format(Sys.Date(), '%B %e, %Y')`"
output: 
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    fig_width: 7
    fig_height: 6
    fig_caption: true
    code_folding: show
    df_print: paged
editor_options: 
  chunk_output_type: inline
references:
- id: xie2016bookdown
  type: book
  title: "Bookdown: Authoring books and technical documents with R markdown"
  author: 
  - family: Xie
    given: Yihui
  issued:
    year: 2016
  publisher: CRC Press
  url: https://bookdown.org/yihui/rmarkdown/
---


```{r setup, include=FALSE}
library(tidyverse)
library(sds192)
library(RMySQL)
db <- dbConnect(
  MySQL(), 
  host = "scidb.smith.edu", 
  user = "sds192", 
  password = "DSismfc@S", 
  dbname = "nyctaxi"
)

```

## Introduction


## Exploratory data analysis

Make sure that you can get this chunk to run:

```{sql, connection = db}
SHOW DATABASES
```


Note how the chunk has the engine type `sql` instead of `r`. 
Note always how the results come directly back into R and show up in the HTML output. 

If you want to save the results of your query as a data frame, so that you can use it in any later R chunks, add the `connection` and `output.var` chunk options, like this:

```{sql, connection=db}
SHOW TABLES;
```

```{sql, connection=db}
DESCRIBE yellow;
```

```{sql, connection=db}
DESCRIBE yellow_sum;
```

#Emily Attempts

```{sql connection=taxidb}
/*
USE taxidb;

DROP TABLE IF EXISTS taxi_zones;


CREATE TABLE `taxi_zones` (
  `LocationID` varchar(255) NOT NULL DEFAULT '',
  `Borough` varchar(255) NOT NULL DEFAULT '',
  `Zone` varchar(255) NOT NULL DEFAULT '',
  `service_zone` varchar(255) NOT NULL DEFAULT '',
  PRIMARY KEY (`LocationID`)
) ENGINE=MyISAM DEFAULT CHARSET=latin1;

LOAD DATA LOCAL INFILE './taxi+_zone_lookup.csv' INTO TABLE `taxi_zones`
  FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '\"' IGNORE 1 LINES;
  */
```

```{r}

# taxidb <- dbConnect(RMySQL::MySQL(), dbname = "taxidb")
# taxi_zones <- tbl(taxidb, "taxi_zones")
# knitr::opts_chunk$set(
#   message = FALSE,
#   echo = TRUE, 
#   connection = taxidb, 
#   max.print = 20
# )

```

```{sql connection=db}
CREATE TABLE taxi_zones (
  LocationID varchar(255) NOT NULL,
  Borough varchar(255) NOT NULL,
  Zone varchar(255) NOT NULL,
  service_zone varchar(255) NOT NULL,
  PRIMARY KEY (LocationID)
);

LOAD DATA LOCAL INFILE  './taxi+_zone_lookup.csv'
INTO TABLE taxi_zones
FIELDS TERMINATED BY ',' 
ENCLOSED BY '"'
LINES TERMINATED BY '\n'
IGNORE 1 ROWS;
```

```{r}
taxi_zones2 <- read_csv("taxi+_zone_lookup.csv")
```

```{sql, connection=db, output.var="first_hundred_yellow"}
SELECT 
PULocationID, trip_distance, fare_amount, tip_amount
FROM yellow 
JOIN taxi_zones ON yellow.PULocationID = taxi_zones2.LocationID
```


```{sql, connection=db}
/*DESCRIBE yellow_old_sum;*/

SELECT * 
FROM yellow_old_sum
LIMIT 10;
```

```{sql, connection=db, output.var="first_ten_yellow"}
SELECT * 
FROM yellow 
LIMIT 0, 10;
```

```{sql connection = db, output.var = "total_amount_1k"}
SELECT total_amount
FROM yellow
LIMIT 100;
```

```{sql connection = db, output.var = "passenger_count"}
SELECT passenger_count
FROM yellow
LIMIT 100;
```

Now we have this object in R:

```{r}
tables
yellow
#yellowsum
first_ten_yellow
total_amount_1k
passenger_count
```

#Cash
```{sql connection=db}
SELECT  tpep_dropoff_datetime, payment_type, total_amount, tip_amount, passenger_count, trip_distance
FROM yellow
WHERE passenger_count < 4 
  AND total_amount < 80 
  AND tip_amount > 0
  AND payment_type = 2
ORDER BY trip_distance desc
LIMIT 10;
```

#Credit
```{sql connection = db, output.var = "payment_cc"}
SELECT  tpep_dropoff_datetime, total_amount, tip_amount, passenger_count, trip_distance
FROM yellow
WHERE passenger_count < 4
  AND total_amount < 80 
  AND tip_amount > 0
  AND payment_type = 1
ORDER BY trip_distance desc
LIMIT 10;
```

#Both Types of Payment
```{sql connection = db, output.var = "payment"}
SELECT  tpep_dropoff_datetime, PULocationID, passenger_count, trip_distance, payment_type, total_amount, tip_amount, (tip_amount/total_amount)*100 AS tip_percent
FROM yellow
WHERE passenger_count < 4
  AND total_amount < 80 
  AND tip_amount > 0
ORDER BY trip_distance desc
LIMIT 10;

```

#Trying to change values in payment_type
#Doesn't Work
```{sql connection = db}
ALTER TABLE payment
  MODIFY payment_type varchar(255);
```
```{sql connection = db} 
UPDATE payment
  SET payment_type = 'Credit' 
  WHERE payment_type = 1;
 
```

```{r}
payment_cc
payment
```

```{r}
payments_join <- payment %>%
  inner_join(taxi_zones2, by=c("PULocationID" = "LocationID"))

tip_by_borough <- payments_join %>%
  group_by(Borough)%>%
  summarize(
    N = n(),
    average = mean(tip_percent)
  )
```


Please see the [SQL chapter of the `bookdown` book](
https://rmarkdown.rstudio.com/authoring_knitr_engines.html%23sql#sql) for more information. 

You can cite references using parentheses or not. @xie2016bookdown wrote about this. See also [@xie2016bookdown].

```{r airport-map, fig.cap="Map of the first ten airports."}
# library(leaflet)
# leaflet() %>%
#   addTiles() %>%
#   addMarkers(
#     data = first_ten_airports,
#     popup = ~name
#   )
```


## Query magic

```{r}

#flights <- tbl(db, "flights")

```

## Analysis

What did you discover? 

## Conclusion

What did you *learn* about the data set you explored?  

---

## Word count

```{r word_count, message=FALSE, echo=FALSE}
sds192::text_stats()
```


## Standards

In this assignment, we attempted the following [standards](https://beanumber.github.io/sds192/standards.html):

- `r standard_button("query")`: We met the Query standard because we...
- `r standard_button("github")`: We met the Github standard because we...
- `r standard_button("markdown")`: We mastered the R Markdown standard because we...
- `r standard_button("function")`: We mastered the Function standard because we...
- `r standard_button("wrangling")`: We mastered the Wrangling standard because we...
- `r standard_button("iteration")`: We mastered the Iteration standard because we...
- `r standard_button("relational")`: We mastered the Relational standard because we...
- `r standard_button("aesthetics")`: We mastered the Aesthetics standard because we...
- `r standard_button("context")`: We mastered the Context standard because we...
- `r standard_button("ethics")`: We mastered the Ethics standard because we...
- `r standard_button("reshape")`: We mastered the Reshape standard because we...
- `r standard_button("spatial")`: We met the Spatial standard because we...
- `r standard_button("leaflet")`: We met the Leaflet standard because we...



## References
